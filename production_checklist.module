<?php

/**
 * @file
 * Contains production_checklist.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;

/**
 * Implements hook_help().
 */
function production_checklist_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the production_checklist module.
    case 'help.page.production_checklist':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('A checklist for site launch and maintenance based on the active configuration.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_theme().
 */
function production_checklist_theme() {
  return [
    'project_status_link' => [
      // @todo preprocess hook
      'variables' => [
        'link' => NULL,
        'status' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_checklistapi_checklist_info().
 */
function production_checklist_checklistapi_checklist_info() {
  // @todo add basic / extended checklist filter
  // @todo add launch / maintenance checklist filter
  // @todo notification once a checked item has been invalidated by configuration
  // @todo convert formUserInput into fromRoute

  /** @var \Drupal\production_checklist\ProductionChecklistInterface $productionChecklist */
  $productionChecklist = \Drupal::service('production_checklist');
  $definitions = [];
  $definitions['production_checklist'] = [
    '#title' => t('Production Checklist'),
    '#path' => 'admin/config/production_checklist/checklist',
    '#description' => t('Production environment checklist. Happiness is in ticking boxes.'),
    '#help' => '<p>' . t('A checklist for site launch and maintenance based on the active configuration.') . '</p>',
    // Drupal system check.
    'drupal_system' => [
      '#title' => t('Drupal system'),
      '#description' => '<h2>' . t('System wide status and reports') . '</h2>',
      'status_report' => [
        '#title' => t('Review status report'),
        '#description' => t('Contains general system information.'),
        'path' => [
          '#text' => t('Status report'),
          '#url' => Url::fromUserInput('/admin/reports/status'),
        ],
      ],
      'site_information' => [
        '#title' => t('Site information'),
        '#description' => t('Make sure the email address and site name are correct. Check the homepage title.'),
        'path' => [
          '#text' => t('Basic site settings'),
          '#url' => Url::fromUserInput('/admin/config/system/site-information'),
        ],
      ],
      'recent_logs' => [
        '#title' => t('Review recent logs'),
        // @todo add service for log errors based on a config threshold
        '#description' => t('Monitor your site or debug site problems.'),
        'path' => [
          '#text' => t('Recent log messages'),
          '#url' => Url::fromUserInput('/admin/reports/dblog'),
        ],
      ],
      'error_display' => [
        '#title' => t('Disable error display'),
        // @todo add service for log errors based on a config threshold
        '#description' => t('Disable any errors output on frontend.'),
        'path' => [
          '#text' => t('Logging and errors'),
          '#url' => Url::fromUserInput('/admin/config/development/logging'),
        ],
      ],
      'core_search' => [
        '#title' => t('Core search'),
        '#description' => t('Disable core search if not relevant or if a replacement search is used (Search API, ...).'),
        'path' => $productionChecklist->getModulesPageTextUrl(),
      ],
      'syslog' => [
        '#title' => t('Enable Syslog core module and optionally disable Database Logging for performance.'),
        '#description' => t('Logs and records system events to syslog.'),
        // @todo check modules status
        'path' => $productionChecklist->getModulesPageTextUrl(),
      ],
    ],
    // Drupal codebase.
    'drupal_codebase' => [
      '#title' => t('Drupal code base'),
      '#description' => '<h2>' . t('Contributed projects review') . '</h2><p>' . t('Core, modules and themes.') . '</p>',
      'development_modules' => [
        '#title' => t('Uninstall development modules like Devel (Devel, Devel generate, Kint, Webprofiler).'),
        // @todo check modules status
        '#description' => $productionChecklist->getDevelopmentModulesStatusLink(),
        'path' => $productionChecklist->getModulesUninstallPageTextUrl(),
      ],
      'unused_modules' => [
        '#title' => t('Unused modules'),
        '#description' => 'Uninstall and remove unused modules.',
        'path' => $productionChecklist->getModulesUninstallPageTextUrl(),
      ],
      'unused_themes' => [
        '#title' => t('Unused themes'),
        '#description' => 'Uninstall and remove unused themes.',
        'path' => [
          '#text' => t('Appearance'),
          '#url' => Url::fromRoute('system.themes_page'),
        ],
      ],
    ],
    // Other codebase.
    'other_codebase' => [
      '#title' => t('Other code base'),
      '#description' => '<h2>' . t("Vendors, custom code and libraries") . '</h2>',
      'development_vendors' => [
        '#title' => t('Remove development vendors like PHPUnit, Behat.'),
        '#description' => t('Run <code>composer install --no-dev</code>'),
        'documentation' => [
          '#text' => t('Composer install documentation'),
          '#url' => Url::fromUri(t('https://getcomposer.org/doc/03-cli.md#install')),
        ],
      ],
      'custom_libraries' => [
        '#title' => t('Remove unused libraries.'),
        '#description' => t('Check the /libraries directory'),
      ],
      'node_modules' => [
        '#title' => t('Node modules'),
        '#description' => t('Check if Node modules dedicated to SASS build, ... are not in the codebase.'),
      ],
      'phpmd' => [
        '#title' => t('PHP Mess Detector'),
        '#description' => t('Run PHP Mess Detector on custom code.'),
        'documentation' => [
          '#text' => t('PHP Mess Detector'),
          '#url' => Url::fromUri(t('https://phpmd.org/')),
        ],
      ],
      'phpcs' => [
        '#title' => t('PHPCS'),
        '#description' => t('Run the <code>phpcs</code> command on custom code.'),
        'documentation' => [
          '#text' => t('PHP Coding Standards'),
          '#url' => Url::fromUri(t('https://www.drupal.org/docs/develop/standards/coding-standards')),
        ],
      ],
    ],
    // Spam prevention.
    'spam_prevention' => [
      '#title' => t('Spam prevention'),
      '#description' => '<h2>' . t('Spam related configuration and modules') . '</h2>',
      'user_registration' => [
        '#title' => t('Review user registration'),
        // @todo add service for current setting
        '#description' => t('Depending on the use case, new account creations can be limited to administrators.'),
      ],
      'content_permissions' => [
        '#title' => t('Check permissions for <em>content</em> creation'),
        '#description' => t('Node related permissions.'),
      ],
      'comment_permissions' => [
        '#title' => t('Check permissions for <em>comment</em> creation'),
        '#description' => 'Comment related permissions.',
      ],
      'forms' => [
        '#title' => t('Check contact form and webform configuration'),
        '#description' => t('Are the main contact form and personal contact form enabled? Is Webform installed?'),
      ],
      'antispam' => [
        '#title' => t('Are the forms protected with Honeypot and Captcha (and optionally reCaptcha)?'),
        // @todo depend on forms settings
        '#description' => $productionChecklist->getAntiSpamStatusLink(),
      ],
      'email_obfuscation' => [
        '#title' => t('Email obfuscation'),
        '#description' => t('Are the email addresses protected against bots harvesting? In fields, WYSIWYG, Twig.'),
      ],
    ],
    // Security and access control.
    'security_access' => [
      '#title' => t('Security and access'),
      '#description' => '<h2>' . t('Security and access control') . '</h2><p>' . t('This topic can be extended with @site_audit_link and @security_review_link. Basically, test simultaneous and consequent anonymous access scenarios and behavior when every cache is enabled.',
       [
         '@site_audit_link' => $productionChecklist->getProjectLink('site_audit'),
         '@security_review_link' => $productionChecklist->getProjectLink('security_review'),
       ]
      ) . '</p>',
      'security_update' => [
        '#title' => t('Drupal and other projects update'),
        // @todo add on service
        '#description' => t('Are all the security updates applied?'),
        'path' => [
          '#text' => t('Available updates'),
          '#url' => Url::fromUserInput('/admin/reports/updates'),
        ],
      ],
      'permission' => [
        '#title' => t('Review the permissions'),
        '#description' => t('This should be done for each role.'),
        'path' => [
          '#text' => t('Permissions'),
          '#url' => Url::fromUserInput('/admin/people/permissions'),
        ],
      ],
      'input_format' => [
        '#title' => t('Input format'),
        '#description' => t('Make sure that input formats are correctly configured. <em>Full HTML</em> should be avoided for untrusted users.'),
        'path' => [
          '#text' => t('Text formats and editors'),
          '#url' => Url::fromUserInput('/admin/config/content/formats'),
        ],
      ],
      'admin_username' => [
        '#title' => t('Admin user name'),
        '#description' => t("The user 1 name (or other users that have the administrator role) should not be defined as 'admin' so it will be harder to guess for attackers."),
      ],
      'password' => [
        '#title' => t('Check passwords'),
        '#description' => t('Passwords should be hard to guess, especially for author and admin roles. Use a module like Password Policy.'),
        'password_policy' => [
          '#text' => t('Password Policy'),
          '#url' => Url::fromUri('https://www.drupal.org/project/password_policy'),
        ],
      ],
      'access_denied' => [
        '#title' => t('Review access denied errors'),
        '#description' => t('If needed block IP addresses with the core Ban module. This process can be completed with the recent log messages.'),
        'path' => [
          '#text' => t('Top access denied errors'),
          '#url' => Url::fromUserInput('/admin/reports/access-denied'),
        ],
      ],
      'changelog' => [
        '#title' => t('Changelog'),
        '#description' => t('Do not publish CHANGELOG.txt and other .txt files at the root of the code base.'),
      ],
      'staging_local' => [
        '#title' => t('Staging and dev environments'),
        '#description' => t('Make sure that your staging and dev environments does not contain sensitive data and are protected with @shield_link if accessible from the outside.', [
          '@shield_link' => $productionChecklist->getProjectLink('shield'),
        ]),
        'documentation' => [
          '#text' => t('Securing Non-Production Environments'),
          '#url' => Url::fromUri('https://dev.acquia.com/blog/securing-nonproduction-environments/09/03/2018/19251'),
        ],
      ],
    ],
    // Content model and content.
    'content' => [
      '#title' => t('Content'),
      '#description' => '<h2>' . t('Content model review and proofreading') . '</h2>',
      'content_model' => [
        '#title' => t('Review content model'),
        '#description' => t('Remove unused content types, vocabularies, roles, fields, ...'),
      ],
      'dummy_content' => [
        '#title' => t('Remove dummy content'),
        '#description' => t('Content, terms, users, ... dedicated to site building (e.g. devel generated) should not be there.'),
      ],
      'proofreading' => [
        '#title' => t('Proofreading'),
        '#description' => t('Content proofreading.'),
      ],
      'forms_test' => [
        '#title' => t('Remove forms tests'),
        '#description' => t('Webform provides a test deletion tab for each webform.'),
      ],
      'files' => [
        '#title' => t('Files sub directories'),
        '#description' => t('Configure file and media fields for storing files in sub directories instead of the <em>sites/default/files</em> root.'),
      ],
    ],
    // Frontend.
    'frontend' => [
      '#title' => t('Frontend'),
      '#description' => '<h2>' . t('Frontend basic checks') . '</h2>',
      'maintenance_page' => [
        '#title' => t('Provide a maintenance page'),
        '#description' => t('Check the maintenance page layout.'),
      ],
      'not_found' => [
        '#title' => t('Provide a good 404 page'),
        '#description' => t('Check the 404 page layout. Optionally provide a dedicated design and improve it (smart 404, search engine, ...).'),
      ],
      'access_denied' => [
        '#title' => t('Provide a good 403 page'),
        '#description' => t('Check the 403 page layout. Provide options to login and redirect to the accessed route.'),
      ],
      'favicon' => [
        '#title' => t('Favicon'),
        '#description' => t('Provide favicons in several formats.'),
      ],
    ],
    // Database and configuration.
    'database' => [
      '#title' => t('Database'),
      '#description' => '<h2>' . t('Database and configuration') . '</h2>',
      'db_update' => [
        '#title' => t('Check database update'),
        '#description' => t('Run /update.php, get a backup first.'),
      ],
      'entity_update' => [
        '#title' => t('Check entity update'),
        '#description' => t('Run <code>drush entup</code>.'),
      ],
      'configuration_export' => [
        '#title' => t('Export current configuration'),
        '#description' => t('Run <code>drush cex</code>.'),
      ],
    ],
    // Performance.
    'performance' => [
      '#title' => t('Performance'),
      '#description' => '<h2>' . t('Performance and caching configuration') . '</h2><p>' . t('To go deeper, consider using @varnish_link, @memcached_link, @advagg_link.',
          [
            '@varnish_link' => $productionChecklist->getProjectLink('varnish_purge'),
            '@memcached_link' => $productionChecklist->getProjectLink('memcache'),
            '@advagg_link' => $productionChecklist->getProjectLink('advagg'),
          ]) . '</p>',
      'caching' => [
        '#title' => t('Caching'),
        '#description' => t('Are page caching and CSS/JS aggregation enabled?'),
        'masquerade' => [
          '#text' => t('Performance'),
          '#url' => Url::fromUserInput(t('/admin/config/development/performance')),
        ],
      ],
      'big_pipe' => [
        '#title' => t('BigPipe'),
        '#description' => t('Consider enabling the BigPipe module.'),
        'path' => $productionChecklist->getModulesPageTextUrl(),
      ],
      // @todo improve
      'views' => [
        '#title' => t('Views'),
        '#description' => t('Checks views caching (on a View edit: Advanced > Other > Caching).'),
      ],
      'custom_code' => [
        '#title' => t('Custom code'),
        '#description' => t('Check cache tags and invalidation, make use of Drupal cache for heavy tasks.'),
      ],
      'audit' => [
        '#title' => t('Audit performances'),
        '#description' => t('Use tools like Google PageSpeed Insight or Acquia Insight.'),
        'google_page_speed' => [
          '#text' => 'Google PageSpeed Insights',
          '#url' => Url::fromUri('https://developers.google.com/speed/pagespeed/insights/'),
        ],
        'acquia_insight' => [
          '#text' => 'Acquia Insight',
          '#url' => Url::fromUri('https://www.acquia.com/resources/collateral/acquia-insight-data-sheet'),
        ],
      ],
      'profiler' => [
        '#title' => t('Profilers'),
        '#description' => t('Use profilers like XHProf or Blackfire.'),
        'xhprof' => [
          '#text' => 'XHProf Drupal.org documentation',
          '#url' => Url::fromUri('https://www.drupal.org/docs/develop/development-tools/xhprof-code-profiler'),
        ],
        'blackfire' => [
          '#text' => 'Blackfire.io',
          '#url' => Url::fromUri('https://blackfire.io/'),
        ],
      ],
    ],
    'test' => [
      '#title' => t('Testing'),
      '#description' => '<h2>' . t('Various test coverages') . '</h2>',
      'manual_test' => [
        '#title' => t('Manual test'),
        '#description' => t('Test the website for each role, anonymous included. Test with caches enabled. Use @masquerade_link to substitute as other users.', [
          '@masquerade_link' => $productionChecklist->getProjectLink('masquerade'),
        ]),
      ],
      'behat' => [
        '#title' => t('Behat tests'),
        '#description' => t('BDD tests with Behat. Fast and affordable.'),
        'path' => [
          '#text' => t('Behat'),
          '#url' => Url::fromUri(t('http://behat-drupal-extension.readthedocs.io/en/3.1/intro.html')),
        ],
      ],
      'php_unit' => [
        '#title' => t('Run PHPUnit tests'),
        '#description' => t('Use them before a deployment: Functional, Kernel, Javascript, ...'),
        '#text' => t('PHP Unit'),
        '#url' => Url::fromUri(t('https://www.drupal.org/docs/8/phpunit')),
      ],
      'ci' => [
        '#title' => t('Continuous Integration system'),
        '#description' => t('Use tools that fits your needs like Travis CI, CircleCI, Jenkins.'),
        'travis_ci' => [
          '#text' => t('Travis CI'),
          '#url' => Url::fromUri(t('https://travis-ci.org/')),
        ],
        'circle_ci' => [
          '#text' => t('CircleCI'),
          '#url' => Url::fromUri(t('https://circleci.com/')),
        ],
        'jenkins' => [
          '#text' => t('Jenkins'),
          '#url' => Url::fromUri(t('https://jenkins.io/')),
        ],
      ],
    ],
    'analytics' => [
      '#title' => t('Analytics'),
      '#description' => '<h2>' . t('Analytics') . '</h2>',
      'google_analyics' => [
        '#title' => t('Google Analytics'),
        '#description' => t('Is the @ga_link module installed and configured?', [
          '@ga_link' => $productionChecklist->getProjectLink('google_analytics'),
        ]),
      ],
      'google_webmaster_tools' => [
        '#title' => t('Google webmaster tools'),
        '#description' => t('Are Google webmaster tools configured?'),
      ],
      'heatmap' => [
        '#title' => t('Heatmap'),
        '#description' => t('Is Hotjar or another heatmap service installed and configured?'),
        'hotjar' => [
          '#text' => t('Hotjar'),
          '#url' => Url::fromUri('https://www.hotjar.com/'),
        ],
      ],
    ],
    // Sysadmin check.
    'sysadmin' => [
      '#title' => t('Sysadmin and backups'),
      '#description' => '<h2>' . t('Server configuration and backups') . '</h2>',
      'backup' => [
        '#title' => t('Backups'),
        '#description' => t('Make sure that you have database and files backups enabled. Use a module like @bam_link with NodeSquirrel.', [
          '@bam_link' => $productionChecklist->getProjectLink('backup_migrate'),
        ]),
        'nodesquirrel' => [
          '#text' => 'NodeSquirrel',
          '#url' => Url::fromUri('https://www.nodesquirrel.com/'),
        ],
      ],
      'mail' => [
        '#title' => t('Mails'),
        '#description' => t('Have mails being tested for each form (e.g. password reset). Is a third party needed, like Mandrill or Sendgrid? Are SPF and PTR ok?'),
      ],
      'ssl' => [
        '#title' => t('SSL certificate'),
        '#description' => t("Free SSL certificates are available from Let's Encrypt."),
        'lets_encrypt' => [
          '#text' => t("Let's Encrypt"),
          '#url' => Url::fromUri('https://letsencrypt.org/'),
        ],
      ],
      'max_upload' => [
        '#title' => t('Maximum file upload size'),
        '#description' => t("This should be set in your per vhost php.ini configuration if available. Set <code>post_max_size</code> and <code>upload_max_filesize</code> according to your needs."),
      ],
      'resources' => [
        '#title' => t('Maximum memory and execution time'),
        '#description' => t("This should be set in your per vhost php.ini configuration if available. Set <code>memory_limit</code> and <code>max_execution_time</code> according to your needs."),
      ],
      'file_permission' => [
        '#title' => t('Check files / directories permissions and ownership'),
        '#description' => t('Usually one owner and group per virtual host, files at 644 and directories at 755.'),
      ],
      'cron_job' => [
        '#title' => t('Check cron jobs'),
        '#description' => t('Modules like Scheduler should work properly. If you have custom cron jobs, check if your system cron is executed on startup and configured properly for your user.'),
        // @todo check if Automated Cron is enabled
      ],
      'load_monitor' => [
        '#title' => t('Monitor your server and check the server load'),
        '#description' => t('Configure your monitoring, optionally use a service like New Relic. Will your server support peaks?'),
        'new_relic' => [
          '#text' => t("New Relic"),
          '#url' => Url::fromUri('https://newrelic.com/'),
        ],
      ],
      'reverse_proxy' => [
        '#title' => t('Reverse proxy'),
        '#description' => t('If your production server uses a proxy or load balancer, configure it in your settings.php.'),
      ],
    ],
    // Basic SEO.
    'seo' => [
      '#title' => t('SEO'),
      '#description' => '<h2>' . t('Basic SEO') . '</h2><p>' . t('For an extended list, use @seo_checklist_link.',
        ['@seo_checklist_link' => $productionChecklist->getProjectLink('seo_checklist')]) . '</p>',
      'url_rewriting' => [
        '#title' => t('URL rewriting'),
        '#description' => t('Is URL rewriting enabled and @pathauto_link configured?', [
          '@pathauto_link' => $productionChecklist->getProjectLink('pathauto'),
        ]),
      ],
      'not_found' => [
        '#title' => t("Review 404 errors and redirect 301 legacy URL's"),
        '#description' => t('Consider using the @redirect_link module.',
          [
            '@redirect_link' => $productionChecklist->getProjectLink('redirect'),
          ]),
        'path' => [
          '#text' => t("Top 'page not found' errors"),
          '#url' => Url::fromUserInput('/admin/reports/page-not-found'),
        ],
      ],
      'htaccess' => [
        '#title' => t('Review your .htaccess'),
        '#description' => t('There should be a single accessible URL for your site, redirect non www prefix to www (or the opposite) and http to https.'),
      ],
      'robots' => [
        '#title' => t('Review your robots.txt'),
        '#description' => t('Especially if some paths should be excluded.'),
      ],
      'sitemap' => [
        '#title' => t('Sitemap'),
        '#description' => t('Configure your sitemap.xml with a modules like Simple Sitemap.'),
        'simple_sitemap' => [
          '#text' => t('Simple Sitemap module'),
          '#url' => Url::fromUri('https://drupal.org/project/simple_sitemap'),
        ],
      ],
      'submit_url' => [
        '#title' => t('Submit the URL'),
        '#description' => t('For new sites only.'),
        'google_submit' => [
          '#text' => t('Submit URL to Google'),
          '#url' => Url::fromUri('https://www.google.com/webmasters/tools/submit-url'),
        ],
      ],
    ],
    // Legal.
    'legal' => [
      '#title' => t('Legal'),
      '#description' => '<h2>' . t('Legal aspects') . '</h2>',
      'cookie_control' => [
        '#title' => t('Cookie compliance with regulations'),
        '#description' => t('Install a cookie validation module and provide explanation about cookie usage.'),
        'project' => [
          '#text' => t('Cookie control module'),
          '#url' => Url::fromUri('https://www.drupal.org/project/cookiecontrol'),
        ],
      ],
      'conditions' => [
        '#title' => t('Privacy policy and general conditions'),
        '#description' => t('Provide also extra legal information (delivery, cancellation, ...) for commerce use cases.'),
      ],
      'gdpr' => [
        '#title' => t('GDPR'),
        '#description' => t('Check compliance with the General Data Protection Regulation.'),
        'project' => [
          '#text' => t('GDPR module'),
          '#url' => Url::fromUri('https://drupal.org/project/gdpr'),
        ],
      ],
    ],
    // Project documentation.
    'documentation' => [
      '#title' => t('Project documentation'),
      '#description' => '<h2>' . t('Documentation related to the persona') . '</h2>',
      'author_documentation' => [
        '#title' => t('Author documentation'),
        '#description' => t('Leave Drupal and custom use cases documentation to the authors, accessible from the Help section.'),
      ],
      'developer_documentation' => [
        '#title' => t('Developer onboarding'),
        '#description' => t('Create a developer onboarding documentation at the root of your repo (README), provide wiki and UML diagrams.'),
      ],
    ],
  ];

  // Append translation items to the content section if multilingual applies.
  if ($productionChecklist->isSiteMultilingual()) {
    $definitions['production_checklist']['content'] += [
      'content_translation' => [
        '#title' => t('Content translation'),
        '#description' => t('Are all the necessary content translated?'),
      ],
      'entity_translation' => [
        '#title' => t('Entity and field translation'),
        '#description' => t('Are all the entities and fields configured properly?'),
        'path' => [
          '#text' => t('Content language'),
          '#url' => Url::fromUserInput(t('/admin/config/regional/content-language')),
        ],
      ],
      'localization' => [
        '#title' => t('Localization'),
        '#description' => t('Is the localization up to date?'),
        'path' => [
          '#text' => t('Available translation updates'),
          '#url' => Url::fromUserInput(t('/admin/reports/translations')),
        ],
      ],
    ];
  }

  return $definitions;
}
